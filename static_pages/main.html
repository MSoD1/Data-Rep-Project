<!DOCTYPE HTML>
<html lang="en">

<head>
   <title>{{ title }}</title>
   <meta charset="UTF-8">
   <meta name="description" content="graphical user interface for sql database">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   <!-- CSS only -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
</head>


    <style>

        /* Styling for banner at the top of the page */
        @media only screen and (min-width: 992px) {
            .navbar {
                flex-direction: column;
                background-color: rgb(255, 255, 255);
            }
        }

        #noScroll input {
            float: right;
            clear: both;
            margin-right: 5%;
        }
        
        #createUpdateForm {
            position: fixed;
            top: 40%;
            left: 47%;
            margin-top: 200px;
            margin-left: -170px;
        }

        #createUpdateForm input{
            width: 240%;
            padding: px;
            margin: 5px 0 5px 0;
            display: inline-block;
            background: #ffffff;    
        }

       #createLabel {
            font-size: 2.5rem;
            font-weight: 100;
            text-align: center;
            color: rgb(0, 139, 134);
        }

        #updateLabel {
            font-size: 2.5rem;
            font-weight: 100;
            text-align: center;
            color: rgb(0, 139, 134);
        }
      
        #BookTable {
            font-weight:400;
        }

        #doCreateButton {
            display: block;
            width: 200px;    
            text-align: center;  
            margin: auto; 
            background-color: rgb(0, 139, 134);
            color: #f8f8f8;
        }

        #doUpdateButton {
            display: block;
            width: 200px;    
            text-align: center;  
            margin: auto; 
            background-color: rgb(0, 139, 134);
            color: #ffffff;
        }

    </style>
	<header>
        <!-- Navigation menu at the top of the page -->
		<div class="navbar">
			<a href="/main.html/"><b>Logout</b><a>
		</div>
	</header> 
    <header> 
        <!-- Banner at the top of the page -->       
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a style="font-size:3rem" class="navbar-brand"><b>ATU iLearn Library<b></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQeEwk7lgwCxaFrgAxdrs2oBWgyQGxcEpdhVQ&usqp=CAU"></a>
            <ul class="navbar-nav mx-auto">        
        </nav>
    <header>
	

   <!-- Form for creating new and updating existing Book data -->
   <div id="createUpdateBook" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 id="titleCreateBook" class="h2">Check Out a Book</h2>
         <h2 id="titleUpdateBook" class="h2">Update Library Log</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showBookDisplay()" type="button" class="btn btn-success">All Books</button>
         <table id="createUpdateBookForm" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">Details</th>
                  <th scope="col">Library Check Out</th>
               </tr>
            </thead>
            <tr>
               <th scope="col">BookID</th>
               <td><input type="text" class="form-control" name="bookID"  placeholder="Enter Book ID" required></td>
            </tr>
            <tr>
               <th scope="col">Author</th>
               <td><input type="text" class="form-control" name="author" placeholder="Enter Author" required></td>
            </tr>
            <tr>
               <th scope="col">Title</th>
               <td><input type="text" class="form-control" name="title" placeholder="Enter Title" required></td>
            </tr>
  
            <tr>
               <td></td>
               <td>
                  <button id="createBook" onclick="doCreateBook()" type="button" class="btn btn-success">Check Out Book</button>
                  <button id="updateBook" onclick="doUpdateBook()"type="button" class="btn btn-info">Update</button>
               </td>
            </tr>
         </table>
      </div>
   </div>

   <!-- Form for creating new and updating existing student data -->
   <div id="createUpdateStudent" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 id="titleCreatestudent" class="h2">Create Student Account</h2>
         <h2 id="titleUpdatestudent" class="h2">Update Student Account</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showstudentDisplay()" type="button" class="btn btn-success">All Students</button>
         <table id="createUpdateStudentForm" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">Details</th>
                  <th scope="col">Student Input</th>
               </tr>
            </thead>
			<tr>
               <th scope="col">BookID</th>
               <td><input type="number" class="form-control" name="bookid" placeholder="Enter Book ID number" required></td>
            </tr>
            <tr>
               <th scope="col">FirstName</th>
               <td><input type="text" class="form-control" name="firstname" placeholder="Enter First Name" required></td>
            </tr>
            <tr>
               <th scope="col">LastName</th>
               <td><input type="text" class="form-control" name="lastname" placeholder="Enter Last Name" required></td>
            </tr>
            <tr>
               <th scope="col">StudentID</th>
               <td><input type="text" class="form-control" name="StudentID" placeholder="Enter Student ID" required></td> 
            </tr>
            <tr>
               <td></td>
               <td>
                  <button id="createstudent" onclick="doCreatestudent()" type="button" class="btn btn-success">Create</button>
                  <button id="updatestudent" onclick="doUpdatestudent()" type="button" class="btn btn-info">Update</button>
               </td>
            </tr>
         </table>
      </div>
   </div>

   <!-- Table for displaying Book data -->
   <div id="displayBook" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Books</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showBookCreate()" type="button" class="btn btn-success">Check Out Book</button>
         <table id="BookTable" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">BookID</th>
                  <th scope="col">Author</th>
                  <th scope="col">Title</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>

   <!-- Table for displaying student data -->
   <div id="displayStudent" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Student Information</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showstudentCreate()" type="button" class="btn btn-success">Create Student Account</button>
         <table id="studentTable" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">BookID</th>
                  <th scope="col">FirstName</th>
                  <th scope="col">LastName</th>
                  <th scope="col">StudentID</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>

   <!-- Table for displaying Home page -->
   <div id="displayHome">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Home</h2>
         <table id="HomeTable" class="table table-dark">
            <tr>
               <td>
                  <!-- Link to Book display table -->
                  <button onclick="showBookDisplay()" type="button" class="btn btn-success">All Books</button>
               </td>
            </tr>
            <tr>
               <td>
                  <!-- Link to student display table -->
                  <button onclick="showstudentDisplay()" type="button" class="btn btn-success">All Students</button>
               </td>
            </tr>
         </table>
      </div>
   </div>
   <hr>

   <script>

      logoutForm = document.getElementById("logout-form");
      host = window.location.origin
      logoutForm.action = host + "/logout";

      function showBookDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "block"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "none"
      }

      function showBookCreate(){
         clearBookForm()
         
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "block"
         document.getElementById('createUpdateStudent').style.display = "none"
         // title
         document.getElementById('titleCreateBook').style.display = "block"
         document.getElementById('titleUpdateBook').style.display = "none"
         // buttons
         document.getElementById('createBook').style.display = "block"
         document.getElementById('updateBook').style.display = "none"
      }

      function showBookUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         var Book = readBookFromRow(rowElement)
         populateBookForm(Book)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "block"
         document.getElementById('createUpdateStudent').style.display = "none"
         // title
         document.getElementById('titleCreateBook').style.display = "none"
         document.getElementById('titleUpdateBook').style.display = "block"
         // buttons
         document.getElementById('createBook').style.display = "none"
         document.getElementById('updateBook').style.display = "block"
      }

      function readBookFromRow(rowElement) {
         var Book = {}
         Book.bookID = rowElement.getAttribute("id").substr(1);
         Book.author = rowElement.cells[1].firstChild.textContent
         Book.title = rowElement.cells[2].firstChild.textContent
         return Book
      }
      function populateBookForm(Book) {
         var form = document.getElementById('createUpdateBookForm')

         form.querySelector('input[name="bookID"]').value = Book.bookID
         //form.querySelector('input[name="bookID"]').disabled = true

         form.querySelector('input[name="author"]').value = Book.author
         form.querySelector('input[name="title"]').value = Book.title
      }
      function clearBookForm() {
         var form = document.getElementById('createUpdateBookForm')

         form.querySelector('input[name="bookID"]').value = ''
         //form.querySelector('input[name="bookID"]').disabled = true

         form.querySelector('input[name="author"]').value = ''
         form.querySelector('input[name="title"]').value = ''
      }

      function doUpdateBook() {
         var Book = getBookFromForm()
         if (validateBookForm(Book) == 1) {
            updateBookServer(Book)         
         }
      }

      function updateBookServer(Book) {
         // ajax updateBook
         host = window.location.origin
         $.ajax({
            url: host + "/book/" + Book.bookID,
            data: JSON.stringify(Book),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updateBookTableRow(Book)
               showBookDisplay()
               clearBookForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
            }
         })
      }

      function updateBookTableRow(Book) {
         var rowElement = document.getElementById(Book.bookID)
         //var rowElement.cells[0].firstChild.textContent = Book.bookID
		 rowElement.cells[1].firstChild.textContent = Book.author
         rowElement.cells[2].firstChild.textContent = Book.title
         //console.log("updating Book table")
      }

      function doCreateBook() {
         var Book = getBookFromForm()
         if (validateBookForm(Book) == 1) {
            // ajax createBook
            host = window.location.origin
            $.ajax({
               url: host + '/book',
               data: JSON.stringify(Book),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Book " + result + " added")
                  Book.BookID = result
                  addBooktoTable(Book)
                  showBookDisplay()
                  clearBookForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
               }
            })
         }

      }

      function doBookDelete(thisElem){
         var tableElement = document.getElementById('BookTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         var Book = rowElement.getAttribute("id").substr(1);
         // ajax deleteBook
         host = window.location.origin
         $.ajax({
            url: host + "/book/"+Book,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               console.log(result)
               if (result.done == false){
                  alert("WARNING: Cannot delete Book with associated with book id!")
               } else {
                  tableElement.deleteRow(index);
                  console.log("Book " + Book + " deleted")
               }
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showstudentDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "block"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "none"
      }

      function showstudentCreate() {
         clearstudentForm()

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "block"
         // title
         document.getElementById('titleCreatestudent').style.display = "block"
         document.getElementById('titleUpdatestudent').style.display = "none"
         // buttons
         document.getElementById('createstudent').style.display = "block"
         document.getElementById('updatestudent').style.display = "none"
      }

      function showstudentUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         var student = readstudentFromRow(rowElement)
         populatestudentForm(student)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "block"
         // title
         document.getElementById('titleCreatestudent').style.display = "none"
         document.getElementById('titleUpdatestudent').style.display = "block"
         // buttons
         document.getElementById('createstudent').style.display = "none"
         document.getElementById('updatestudent').style.display = "block"
      }

      function readstudentFromRow(rowElement) {
         var student = {}
         student.bookid = rowElement.getAttribute("id").substr(1);
         student.firstname = rowElement.cells[1].firstChild.textContent
         student.lastname = rowElement.cells[2].firstChild.textContent
         student.StudentID = rowElement.cells[3].firstChild.textContent
         return student
      }

      function populatestudentForm(student) {
         var form = document.getElementById('createUpdateStudentForm')

         form.querySelector('input[name="bookid"]').value = student.bookid
         //form.querySelector('input[name="bookid"]').disabled = true

         form.querySelector('input[name="firstname"]').value = student.firstname
         form.querySelector('input[name="lastname"]').value = student.lastname
         form.querySelector('input[name="StudentID"]').value = student.StudentID
      }
      function clearstudentForm() {
         var form = document.getElementById('createUpdateStudentForm')

         form.querySelector('input[name="bookid"]').value = ''
        // form.querySelector('input[name="bookid"]').disabled = true

         form.querySelector('input[name="firstname"]').value = ''
         form.querySelector('input[name="lastname"]').value = ''
         form.querySelector('input[name="StudentID"]').value = ''
      }

      function doUpdatestudent() {
         var student = getstudentFromForm()
         if (validatestudentForm(student) == 1) {
            updatestudentServer(student)       
         }
      }

      function updatestudentServer(student) {
         // ajax updatestudent
         host = window.location.origin
         $.ajax({
            url: host + "/students/" + student.bookid,
            data: JSON.stringify(student),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updatestudentTableRow(student)
               showstudentDisplay()
               clearstudentForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
               // NOTE: BookID has to exist to assign a student to a BookID
               alert("WARNING: INPUT ERROR ID not found!")
            }
         })
      }

      function updatestudentTableRow(student) {
         var rowElement = document.getElementById(student.bookid)
         rowElement.cells[1].firstChild.textContent = student.firstname
         rowElement.cells[2].firstChild.textContent = student.lastname
         rowElement.cells[3].firstChild.textContent = student.StudentID
      }

      function doCreatestudent() {
         var student = getstudentFromForm()
         if (validatestudentForm(student) == 1) {
            // ajax createstudent
            host = window.location.origin
            $.ajax({
               url: host + '/students',
               data: JSON.stringify(student),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("student Account " + result + " created")
                  student.bookid = result
                  addstudentTable(student)
                  showstudentDisplay()
                  clearstudentForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
                  // NOTE: bookid has to exist to assign a student to a bookid
                  alert("WARNING: INPUT ERROR Department ID not found!")
               }
            })
         }
      }

      function dostudentDelete(thisElem){
         var tableElement = document.getElementById('studentTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         var student = rowElement.getAttribute("id").substr(1);
         // ajax deletestudent
         host = window.location.origin
         $.ajax({
            url: host + "/students/"+ student,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               tableElement.deleteRow(index);
               console.log(" Book " + student + "has been deleted from Student Account")
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showHome() {
         document.getElementById('displayHome').style.display = "block"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "none"
      }

      function getBookFromForm(){
         var form = document.getElementById('createUpdateBookForm')
         var Book = {}
         Book.bookID = parseInt(form.querySelector('input[name="bookID"]').value)
         Book.author = form.querySelector('input[name="author"]').value
         Book.title = form.querySelector('input[name="title"]').value
         // console.log(Book)
         return Book
      }

      function validateBookForm(d){
         // Code adapted from
         // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isNaN
         if (d.author.length == 0 || d.title.length == 0) {
            alert("WARNING: Please Include an Author and Title")
            return 0
         }
         return 1
      }

      function getstudentFromForm(){
         var form = document.getElementById('createUpdateStudentForm')
         var student = {}
         student.bookid = parseInt(form.querySelector('input[name="bookid"]').value)
         student.firstname = form.querySelector('input[name="firstname"]').value
         student.lastname = form.querySelector('input[name="lastname"]').value
         student.StudentID = parseInt(form.querySelector('input[name="StudentID"]').value)
         // console.log(student)
         return student
      }

      function validatestudentForm(e){
         // Check if any fields are empty
         if (e.firstname.length == 0 || e.lastname.length == 0 || Number.isNaN(e.StudentID) == true){
            alert("WARNING: Please include your Full Name and Student Number")
            return 0
         }
         return 1
      }

      function populateBookTable(){
         // ajax getAllBook
         host = window.location.origin
         $.ajax({
            url: host + '/book',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (Book of results) {
                  addBooktoTable(Book)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function populatestudentTable(){
         // ajax getAllstudent
         host = window.location.origin
         $.ajax({
            url: host + '/students',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (student of results) {
                  addstudentTable(student)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function addBooktoTable(Book){
         // console.log("add to Book table working")
         var tableElem = document.getElementById('BookTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "d"+Book.bookID)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = Book.bookID
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = Book.author
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = Book.title
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = '<button onclick="showBookUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="doBookDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      function addstudentTable(student){
         // console.log("add to student table working")
         var tableElem = document.getElementById('studentTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "e"+student.bookid)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = student.bookid
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = student.firstname
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = student.lastname
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = student.studentID
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="showstudentUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell6 = rowElem.insertCell(5);
         cell6.innerHTML = '<button onclick="dostudentDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      populateBookTable()
      populatestudentTable()

   </script>
</body>

</html>
