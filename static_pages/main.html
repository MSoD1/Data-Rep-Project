<!DOCTYPE HTML>
<html lang="en">

<head>
   <title>{{ title }}</title>
   <meta charset="UTF-8">
   <meta name="description" content="graphical user interface for sql database">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   <!-- CSS only -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
</head>


    <style>

        /* Styling for banner at the top of the page */
        @media only screen and (min-width: 992px) {
            .navbar {
                flex-direction: column;
                background-color: rgb(255, 255, 255);
            }
        }

        #noScroll input {
            float: right;
            clear: both;
            margin-right: 5%;
        }
        
        #createUpdateForm {
            position: fixed;
            top: 40%;
            left: 47%;
            margin-top: 200px;
            margin-left: -170px;
        }

        #createUpdateForm input{
            width: 240%;
            padding: px;
            margin: 5px 0 5px 0;
            display: inline-block;
            background: #ffffff;    
        }

       #createLabel {
            font-size: 2.5rem;
            font-weight: 100;
            text-align: center;
            color: rgb(0, 139, 134);
        }

        #updateLabel {
            font-size: 2.5rem;
            font-weight: 100;
            text-align: center;
            color: rgb(0, 139, 134);
        }
      
        #bookTable {
            font-weight:400;
        }

        #doCreateButton {
            display: block;
            width: 200px;    
            text-align: center;  
            margin: auto; 
            background-color: rgb(0, 139, 134);
            color: #f8f8f8;
        }

        #doUpdateButton {
            display: block;
            width: 200px;    
            text-align: center;  
            margin: auto; 
            background-color: rgb(0, 139, 134);
            color: #ffffff;
        }

    </style>
	<header>
        <!-- Navigation menu at the top of the page -->
		<div class="navbar">
			<a href="/main.html/"><b>Logout</b><a>
		</div>
	</header> 
    <header> 
        <!-- Banner at the top of the page -->       
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a style="font-size:3rem" class="navbar-brand"><b>ATU iLearn Library<b></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQeEwk7lgwCxaFrgAxdrs2oBWgyQGxcEpdhVQ&usqp=CAU"></a>
            <ul class="navbar-nav mx-auto">        
        </nav>
    <header>
	

   <!-- Form for creating new and updating existing Book data -->
   <div id="createUpdateDept" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 id="titleCreateDept" class="h2">Check Out a Book</h2>
         <h2 id="titleUpdateDept" class="h2">Update Library Log</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showDeptDisplay()" type="button" class="btn btn-success">All Books</button>
         <table id="createUpdateDeptForm" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">Details</th>
                  <th scope="col">Library Check Out</th>
               </tr>
            </thead>
            <tr>
               <th scope="col">DeptID</th>
               <td><input type="text" class="form-control" name="deptID"  placeholder="enter dept id" required></td>
            </tr>
            <tr>
               <th scope="col">Author</th>
               <td><input type="text" class="form-control" name="author" placeholder="enter first name" required></td>
            </tr>
            <tr>
               <th scope="col">Title</th>
               <td><input type="text" class="form-control" name="title" placeholder="enter title" required></td>
            </tr>
  
            <tr>
               <td></td>
               <td>
                  <button id="createDept" onclick="doCreateDept()" type="button" class="btn btn-success">Check Out Book</button>
                  <button id="updateDept" onclick="doUpdateDept()"type="button" class="btn btn-info">Update</button>
               </td>
            </tr>
         </table>
      </div>
   </div>

   <!-- Form for creating new and updating existing Student data -->
   <div id="createUpdatestu" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 id="titleCreatestu" class="h2">Create Student Account</h2>
         <h2 id="titleUpdatestu" class="h2">Update Student Account</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showstuDisplay()" type="button" class="btn btn-success">All Students</button>
         <table id="createUpdatestuForm" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">Details</th>
                  <th scope="col">Student Input</th>
               </tr>
            </thead>
            <tr>
               <th scope="col">StudentID</th>
               <td><input type="text" class="form-control" name="studentID" placeholder="enter student id" required></td> 
            </tr>
            <tr>
               <th scope="col">FirstName</th>
               <td><input type="text" class="form-control" name="firstname" placeholder="enter first name" required></td>
            </tr>
            <tr>
               <th scope="col">LastName</th>
               <td><input type="text" class="form-control" name="lastname" placeholder="enter last name" required></td>
            </tr>
            <tr>
               <th scope="col">Dept</th>
               <td><input type="number" class="form-control" name="dept" placeholder="enter Dept ID number" required></td>
            </tr>
            <tr>
               <td></td>
               <td>
                  <button id="createstu" onclick="doCreatestu()" type="button" class="btn btn-success">Create</button>
                  <button id="updatestu" onclick="doUpdatestu()" type="button" class="btn btn-info">Update</button>
               </td>
            </tr>
         </table>
      </div>
   </div>

   <!-- Table for displaying Book data -->
   <div id="displayDept" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Books</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showDeptCreate()" type="button" class="btn btn-success">Check Out Book</button>
         <table id="deptTable" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">DeptID</th>
                  <th scope="col">Author</th>
                  <th scope="col">Title</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>

   <!-- Table for displaying student data -->
   <div id="displaystu" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Student Information</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showstuCreate()" type="button" class="btn btn-success">Create Student Account</button>
         <table id="stuTable" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">StudentID</th>
                  <th scope="col">FirstName</th>
                  <th scope="col">LastName</th>
                  <th scope="col">Dept</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>

   <!-- Table for displaying Home page -->
   <div id="displayHome">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Home</h2>
         <table id="HomeTable" class="table table-dark">
            <tr>
               <td>
                  <!-- Link to Book display table -->
                  <button onclick="showDeptDisplay()" type="button" class="btn btn-success">All Books</button>
               </td>
            </tr>
            <tr>
               <td>
                  <!-- Link to student display table -->
                  <button onclick="showstuDisplay()" type="button" class="btn btn-success">All Students</button>
               </td>
            </tr>
         </table>
      </div>
   </div>
   <hr>

   <script>

      logoutForm = document.getElementById("logout-form");
      host = window.location.origin
      logoutForm.action = host + "/logout";

      function showDeptDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "block"
         document.getElementById('displaystu').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdatestu').style.display = "none"
      }

      function showDeptCreate(){
         clearDeptForm()
         
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displaystu').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "block"
         document.getElementById('createUpdatestu').style.display = "none"
         // title
         document.getElementById('titleCreateDept').style.display = "block"
         document.getElementById('titleUpdateDept').style.display = "none"
         // buttons
         document.getElementById('createDept').style.display = "block"
         document.getElementById('updateDept').style.display = "none"
      }

      function showDeptUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         var dept = readDeptFromRow(rowElement)
         populateDeptForm(dept)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displaystu').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "block"
         document.getElementById('createUpdatestu').style.display = "none"
         // title
         document.getElementById('titleCreateDept').style.display = "none"
         document.getElementById('titleUpdateDept').style.display = "block"
         // buttons
         document.getElementById('createDept').style.display = "none"
         document.getElementById('updateDept').style.display = "block"
      }

      function readDeptFromRow(rowElement) {
         var dept = {}
         dept.deptID = rowElement.getAttribute("id").substr(1);
         dept.author = rowElement.cells[1].firstChild.textContent
         dept.title = rowElement.cells[2].firstChild.textContent
         return dept
      }
      function populateDeptForm(dept) {
         var form = document.getElementById('createUpdateDeptForm')

         form.querySelector('input[name="deptID"]').value = dept.deptID
         //form.querySelector('input[name="deptID"]').disabled = true

         form.querySelector('input[name="author"]').value = dept.author
         form.querySelector('input[name="title"]').value = dept.title
      }
      function clearDeptForm() {
         var form = document.getElementById('createUpdateDeptForm')

         form.querySelector('input[name="deptID"]').value = ''
         //form.querySelector('input[name="deptID"]').disabled = true

         form.querySelector('input[name="author"]').value = ''
         form.querySelector('input[name="title"]').value = ''
      }

      function doUpdateDept() {
         var dept = getDeptFromForm()
         if (validateDeptForm(dept) == 1) {
            updateDeptServer(dept)         
         }
      }

      function updateDeptServer(dept) {
         // ajax updateDept
         host = window.location.origin
         $.ajax({
            url: host + "/Books/" + dept.deptID,
            data: JSON.stringify(dept),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updateDeptTableRow(dept)
               showDeptDisplay()
               clearDeptForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
            }
         })
      }

      function updateDeptTableRow(dept) {
         var rowElement = document.getElementById(dept.deptID)
         //var rowElement.cells[0].firstChild.textContent = dept.deptID
		 rowElement.cells[1].firstChild.textContent = dept.author
         rowElement.cells[2].firstChild.textContent = dept.title
         //console.log("updating dept table")
      }

      function doCreateDept() {
         var dept = getDeptFromForm()
         if (validateDeptForm(dept) == 1) {
            // ajax createDept
            host = window.location.origin
            $.ajax({
               url: host + '/Books',
               data: JSON.stringify(dept),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Book " + result + " added")
                  dept.deptID = result
                  addDepttoTable(dept)
                  showDeptDisplay()
                  clearDeptForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
               }
            })
         }

      }

      function doDeptDelete(thisElem){
         var tableElement = document.getElementById('deptTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         var dept = rowElement.getAttribute("id").substr(1);
         // ajax deleteDept
         host = window.location.origin
         $.ajax({
            url: host + "/Books/"+dept,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               console.log(result)
               if (result.done == false){
                  alert("WARNING: Cannot delete Book with associated with student id!")
               } else {
                  tableElement.deleteRow(index);
                  console.log("Book " + dept + " deleted")
               }
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showstuDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displaystu').style.display = "block"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdatestu').style.display = "none"
      }

      function showstuCreate() {
         clearstuForm()

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displaystu').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdatestu').style.display = "block"
         // title
         document.getElementById('titleCreatestu').style.display = "block"
         document.getElementById('titleUpdatestu').style.display = "none"
         // buttons
         document.getElementById('createstu').style.display = "block"
         document.getElementById('updatestu').style.display = "none"
      }

      function showstuUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         var stu = readstuFromRow(rowElement)
         populatestuForm(stu)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displaystu').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdatestu').style.display = "block"
         // title
         document.getElementById('titleCreatestu').style.display = "none"
         document.getElementById('titleUpdatestu').style.display = "block"
         // buttons
         document.getElementById('createstu').style.display = "none"
         document.getElementById('updatestu').style.display = "block"
      }

      function readstuFromRow(rowElement) {
         var stu = {}
         stu.studentID = rowElement.getAttribute("id").substr(1);
         stu.firstname = rowElement.cells[1].firstChild.textContent
         stu.lastname = rowElement.cells[2].firstChild.textContent
         stu.dept = rowElement.cells[3].firstChild.textContent
         return stu
      }

      function populatestuForm(stu) {
         var form = document.getElementById('createUpdatestuForm')

         form.querySelector('input[name="studentID"]').value = stu.studentID
         //form.querySelector('input[name="studentID"]').disabled = true

         form.querySelector('input[name="firstname"]').value = stu.firstname
         form.querySelector('input[name="lastname"]').value = stu.lastname
         form.querySelector('input[name="dept"]').value = stu.dept
      }
      function clearstuForm() {
         var form = document.getElementById('createUpdatestuForm')

         form.querySelector('input[name="studentID"]').value = ''
        // form.querySelector('input[name="studentID"]').disabled = true

         form.querySelector('input[name="firstname"]').value = ''
         form.querySelector('input[name="lastname"]').value = ''
         form.querySelector('input[name="dept"]').value = ''
      }

      function doUpdatestu() {
         var stu = getstuFromForm()
         if (validatestuForm(stu) == 1) {
            updatestuServer(stu)       
         }
      }

      function updatestuServer(stu) {
         // ajax updatestu
         host = window.location.origin
         $.ajax({
            url: host + "/students/" + stu.studentID,
            data: JSON.stringify(stu),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updatestuTableRow(stu)
               showstuDisplay()
               clearstuForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
               // NOTE: deptID has to exist to assign a student to a deptID
               alert("WARNING: INPUT ERROR ID not found!")
            }
         })
      }

      function updatestuTableRow(stu) {
         var rowElement = document.getElementById(stu.studentID)
         rowElement.cells[1].firstChild.textContent = stu.firstname
         rowElement.cells[2].firstChild.textContent = stu.lastname
         rowElement.cells[3].firstChild.textContent = stu.dept
      }

      function doCreatestu() {
         var stu = getstuFromForm()
         if (validatestuForm(stu) == 1) {
            // ajax createstu
            host = window.location.origin
            $.ajax({
               url: host + '/students',
               data: JSON.stringify(stu),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Student Account " + result + " created")
                  stu.studentID = result
                  addstutoTable(stu)
                  showstuDisplay()
                  clearstuForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
                  // NOTE: deptID has to exist to assign a student to a deptID
                  alert("WARNING: INPUT ERROR Department ID not found!")
               }
            })
         }
      }

      function dostuDelete(thisElem){
         var tableElement = document.getElementById('stuTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         var stu = rowElement.getAttribute("id").substr(1);
         // ajax deletestu
         host = window.location.origin
         $.ajax({
            url: host + "/students/"+ stu,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               tableElement.deleteRow(index);
               console.log("Student Account " + stu + " deleted")
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showHome() {
         document.getElementById('displayHome').style.display = "block"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displaystu').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdatestu').style.display = "none"
      }

      function getDeptFromForm(){
         var form = document.getElementById('createUpdateDeptForm')
         var dept = {}
         dept.deptID = parseInt(form.querySelector('input[name="deptID"]').value)
         dept.author = form.querySelector('input[name="author"]').value
         dept.title = form.querySelector('input[name="title"]').value
         // console.log(dept)
         return dept
      }

      function validateDeptForm(d){
         // Code adapted from
         // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isNaN
         if (d.author.length == 0 || d.title.length == 0) {
            alert("WARNING: Please Include an Author and Title")
            return 0
         }
         return 1
      }

      function getstuFromForm(){
         var form = document.getElementById('createUpdatestuForm')
         var stu = {}
         stu.studentID = parseInt(form.querySelector('input[name="studentID"]').value)
         stu.firstname = form.querySelector('input[name="firstname"]').value
         stu.lastname = form.querySelector('input[name="lastname"]').value
         stu.dept = parseInt(form.querySelector('input[name="dept"]').value)
         // console.log(stu)
         return stu
      }

      function validatestuForm(e){
         // Check if any student form fields are stuty
         if (e.firstname.length == 0 || e.lastname.length == 0 || Number.isNaN(e.dept) == true){
            alert("WARNING: Please include your Full Name and Dept Number")
            return 0
         }
         return 1
      }

      function populateDeptTable(){
         // ajax getAllDept
         host = window.location.origin
         $.ajax({
            url: host + '/Books',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (dept of results) {
                  addDepttoTable(dept)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function populatestuTable(){
         // ajax getAllstu
         host = window.location.origin
         $.ajax({
            url: host + '/students',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (stu of results) {
                  addstutoTable(stu)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function addDepttoTable(dept){
         // console.log("add to dept table working")
         var tableElem = document.getElementById('deptTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "d"+dept.deptID)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = dept.deptID
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = dept.author
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = dept.title
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = '<button onclick="showDeptUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="doDeptDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      function addstutoTable(stu){
         // console.log("add to stu table working")
         var tableElem = document.getElementById('stuTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "e"+stu.studentID)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = stu.StudentID
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = stu.firstname
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = stu.lastname
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = stu.dept
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="showstuUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell6 = rowElem.insertCell(5);
         cell6.innerHTML = '<button onclick="dostuDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      populateDeptTable()
      populatestuTable()

   </script>
</body>

</html>