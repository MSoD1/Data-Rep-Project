<!DOCTYPE HTML>
<html lang="en">

<head>
   <title>{{ title }}</title>
   <meta charset="UTF-8">
   <meta name="description" content="graphical user interface for sql database">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   <!-- CSS only -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
</head>


    <style>

        /* Styling for banner at the top of the page */
        @media only screen and (min-width: 992px) {
            .navbar {
                flex-direction: column;
                background-color: rgb(255, 255, 255);
            }
        }

        #noScroll input {
            float: right;
            clear: both;
            margin-right: 5%;
        }
        
        #createUpdateForm {
            position: fixed;
            top: 40%;
            left: 47%;
            margin-top: 200px;
            margin-left: -170px;
        }

        #createUpdateForm input{
            width: 240%;
            padding: px;
            margin: 5px 0 5px 0;
            display: inline-block;
            background: #ffffff;    
        }

       #createLabel {
            font-size: 2.5rem;
            font-weight: 100;
            text-align: center;
            color: rgb(0, 139, 134);
        }

        #updateLabel {
            font-size: 2.5rem;
            font-weight: 100;
            text-align: center;
            color: rgb(0, 139, 134);
        }
      
        #bookTable {
            font-weight:400;
        }

        #doCreateButton {
            display: block;
            width: 200px;    
            text-align: center;  
            margin: auto; 
            background-color: rgb(0, 139, 134);
            color: #f8f8f8;
        }

        #doUpdateButton {
            display: block;
            width: 200px;    
            text-align: center;  
            margin: auto; 
            background-color: rgb(0, 139, 134);
            color: #ffffff;
        }

    </style>
	<header>
        <!-- Navigation menu at the top of the page -->
		<div class="navbar">
			<a href="/main.html/"><b>Logout</b><a>
		</div>
	</header> 
    <header> 
        <!-- Banner at the top of the page -->       
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a style="font-size:3rem" class="navbar-brand"><b>ATU iLearn Library<b></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQeEwk7lgwCxaFrgAxdrs2oBWgyQGxcEpdhVQ&usqp=CAU"></a>
            <ul class="navbar-nav mx-auto">        
        </nav>
    <header>
	

   <!-- Form for creating new and updating existing Book data -->
   <div id="createUpdateBook" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 id="titleCreateBook" class="h2">Check Out a Book</h2>
         <h2 id="titleUpdateBook" class="h2">Update Library Log</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showBookDisplay()" type="button" class="btn btn-success">All Books</button>
         <table id="createUpdateBookForm" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">Details</th>
                  <th scope="col">Library Check Out</th>
               </tr>
            </thead>
            <tr>
               <th scope="col">BookID</th>
               <td><input type="text" class="form-control" name="bookID"  placeholder="Enter Book ID" required></td>
            </tr>
            <tr>
               <th scope="col">Author</th>
               <td><input type="text" class="form-control" name="author" placeholder="Enter First Name" required></td>
            </tr>
            <tr>
               <th scope="col">Title</th>
               <td><input type="text" class="form-control" name="title" placeholder="Enter Title" required></td>
            </tr>
  
            <tr>
               <td></td>
               <td>
                  <button id="createBook" onclick="doCreateBook()" type="button" class="btn btn-success">Check Out Book</button>
                  <button id="updateBook" onclick="doUpdateBook()"type="button" class="btn btn-info">Update</button>
               </td>
            </tr>
         </table>
      </div>
   </div>

   <!-- Form for creating new and updating existing Student data -->
   <div id="createUpdatestu" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 id="titleCreateStudent" class="h2">Create Student Account</h2>
         <h2 id="titleUpdateStudent" class="h2">Update Student Account</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showStudentDisplay()" type="button" class="btn btn-success">All Students</button>
         <table id="createUpdateStudentForm" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">Details</th>
                  <th scope="col">Student Input</th>
               </tr>
            </thead>
            <tr>
               <th scope="col">BookID</th>
               <td><input type="text" class="form-control" name="bookid" placeholder="Enter Book ID" required></td> 
            </tr>
            <tr>
               <th scope="col">FirstName</th>
               <td><input type="text" class="form-control" name="firstname" placeholder="Enter First Name" required></td>
            </tr>
            <tr>
               <th scope="col">LastName</th>
               <td><input type="text" class="form-control" name="lastname" placeholder="Enter Last Name" required></td>
            </tr>
            <tr>
               <th scope="col">StudentID</th>
               <td><input type="text" class="form-control" name="studentID" placeholder="Enter Student ID" required></td> 
            </tr>
            <tr>
               <td></td>
               <td>
                  <button id="createStudent" onclick="doCreateStudent()" type="button" class="btn btn-success">Create</button>
                  <button id="updateStudent" onclick="doUpdateStudent()" type="button" class="btn btn-info">Update</button>
               </td>
            </tr>
         </table>
      </div>
   </div>

   <!-- Table for displaying Book data -->
   <div id="displayBook" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Books</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showBookCreate()" type="button" class="btn btn-success">Check Out Book</button>
         <table id="BookTable" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">bookID</th>
                  <th scope="col">Author</th>
                  <th scope="col">Title</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>

   <!-- Table for displaying student data -->
   <div id="displayStudent" style="display:none">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Student Information</h2>
         <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
         <button onclick="showStudentCreate()" type="button" class="btn btn-success">Create Student Account</button>
         <table id="StudentTable" class="table table-dark">
            <thead class="thead-dark">
               <tr>
                  <th scope="col">bookid</th>
                  <th scope="col">FirstName</th>
                  <th scope="col">LastName</th>
                  <th scope="col">StudentID</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>

   <!-- Table for displaying Home page -->
   <div id="displayHome">
      <div style="width:900px; margin:0 auto;">
         <h2 class="h2">Home</h2>
         <table id="HomeTable" class="table table-dark">
            <tr>
               <td>
                  <!-- Link to Book display table -->
                  <button onclick="showBookDisplay()" type="button" class="btn btn-success">All Books</button>
               </td>
            </tr>
            <tr>
               <td>
                  <!-- Link to student display table -->
                  <button onclick="showStudentDisplay()" type="button" class="btn btn-success">All Students</button>
               </td>
            </tr>
         </table>
      </div>
   </div>
   <hr>

   <script>

      logoutForm = document.getElementById("logout-form");
      host = window.location.origin
      logoutForm.action = host + "/logout";

      function showBookDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "block"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "none"
      }

      function showBookCreate(){
         clearBookForm()
         
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "block"
         document.getElementById('createUpdateStudent').style.display = "none"
         // title
         document.getElementById('titleCreateBook').style.display = "block"
         document.getElementById('titleUpdateBook').style.display = "none"
         // buttons
         document.getElementById('createBook').style.display = "block"
         document.getElementById('updateBook').style.display = "none"
      }

      function showBookUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         var book = readBookFromRow(rowElement)
         populateBookForm(book)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "block"
         document.getElementById('createUpdateStudent').style.display = "none"
         // title
         document.getElementById('titleCreateBook').style.display = "none"
         document.getElementById('titleUpdateBook').style.display = "block"
         // buttons
         document.getElementById('createBook').style.display = "none"
         document.getElementById('updateBook').style.display = "block"
      }

      function readBookFromRow(rowElement) {
         var book = {}
         book.bookID = rowElement.getAttribute("id").substr(1);
         book.author = rowElement.cells[1].firstChild.textContent
         book.title = rowElement.cells[2].firstChild.textContent
         return book
      }
      function populateBookForm(book) {
         var form = document.getElementById('createUpdateBookForm')

         form.querySelector('input[name="bookID"]').value = book.bookID
         //form.querySelector('input[name="bookID"]').disabled = true

         form.querySelector('input[name="author"]').value = book.author
         form.querySelector('input[name="title"]').value = book.title
      }
      function clearBookForm() {
         var form = document.getElementById('createUpdateBookForm')

         form.querySelector('input[name="bookID"]').value = ''
         //form.querySelector('input[name="bookID"]').disabled = true

         form.querySelector('input[name="author"]').value = ''
         form.querySelector('input[name="title"]').value = ''
      }

      function doUpdateBook() {
         var book = getBookFromForm()
         if (validateBookForm(book) == 1) {
            updateBookServer(book)         
         }
      }

      function updateBookServer(book) {
         // ajax updateBook
         host = window.location.origin
         $.ajax({
            url: host + "/book/" + book.bookID,
            data: JSON.stringify(book),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updateBookTableRow(book)
               showBookDisplay()
               clearBookForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
            }
         })
      }

      function updateBookTableRow(book) {
         var rowElement = document.getElementById(book.bookID)
         //var rowElement.cells[0].firstChild.textContent = book.bookID
		 rowElement.cells[1].firstChild.textContent = book.author
         rowElement.cells[2].firstChild.textContent = book.title
         //console.log("updating book table")
      }

      function doCreateBook() {
         var dept = getBookFromForm()
         if (validateBookForm(book) == 1) {
            // ajax createBook
            host = window.location.origin
            $.ajax({
               url: host + '/book',
               data: JSON.stringify(book),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Book " + result + " added")
                  book.bookID = result
                  addBooktoTable(book)
                  showBookDisplay()
                  clearBookForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
               }
            })
         }

      }

      function doBookDelete(thisElem){
         var tableElement = document.getElementById('BookTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         var book = rowElement.getAttribute("id").substr(1);
         // ajax deleteBook
         host = window.location.origin
         $.ajax({
            url: host + "/book/"+bookID,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               console.log(result)
               if (result.done == false){
                  alert("WARNING: Cannot delete Book!")
               } else {
                  tableElement.deleteRow(index);
                  console.log("Book " + book + " deleted")
               }
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showStudentDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "block"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "none"
      }

      function showStudentCreate() {
         clearStudentForm()

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "block"
         // title
         document.getElementById('titleCreateStudent').style.display = "block"
         document.getElementById('titleUpdateStudent').style.display = "none"
         // buttons
         document.getElementById('createStudent').style.display = "block"
         document.getElementById('updateStudent').style.display = "none"
      }

      function showStudentUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         var student = readStudentFromRow(rowElement)
         populateStudentForm(student)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "block"
         // title
         document.getElementById('titleCreateStudent').style.display = "none"
         document.getElementById('titleUpdateStudent').style.display = "block"
         // buttons
         document.getElementById('createStudent').style.display = "none"
         document.getElementById('updateStudent').style.display = "block"
      }

      function readStudentFromRow(rowElement) {
         var student = {}
         student.bookid = rowElement.getAttribute("id").substr(1);
         student.firstname = rowElement.cells[1].firstChild.textContent
         student.lastname = rowElement.cells[2].firstChild.textContent
         student.studentID = rowElement.cells[3].firstChild.textContent
         return student
      }

      function populateStudentForm(student) {
         var form = document.getElementById('createUpdateStudentForm')

         form.querySelector('input[name="bookid"]').value = student.bookid
         //form.querySelector('input[name="bookid"]').disabled = true

         form.querySelector('input[name="firstname"]').value = student.firstname
         form.querySelector('input[name="lastname"]').value = student.lastname
         form.querySelector('input[name="studentID"]').value = student.studentID
      }
      function clearStudentForm() {
         var form = document.getElementById('createUpdateStudentForm')

         form.querySelector('input[name="bookid"]').value = ''
        // form.querySelector('input[name="bookid"]').disabled = true

         form.querySelector('input[name="firstname"]').value = ''
         form.querySelector('input[name="lastname"]').value = ''
         form.querySelector('input[name="studentID"]').value = ''
      }

      function doUpdateStudent() {
         var student = getStudentFromForm()
         if (validateStudentForm(student) == 1) {
            updateStudentServer(student)       
         }
      }

      function updateStudentServer(student) {
         // ajax updatestudent
         host = window.location.origin
         $.ajax({
            url: host + "/students/" + student.bookid,
            data: JSON.stringify(student),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updateStudentTableRow(student)
               showStudentDisplay()
               clearStudentForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
               // NOTE: Book Id has to exist
               alert("WARNING: INPUT ERROR ID not found!")
            }
         })
      }

      function updateStudentTableRow(student) {
         var rowElement = document.getElementById(student.bookid)
         rowElement.cells[1].firstChild.textContent = student.firstname
         rowElement.cells[2].firstChild.textContent = student.lastname
         rowElement.cells[3].firstChild.textContent = student.studentID
      }

      function doCreateStudent() {
         var student = getStudentFromForm()
         if (validateStudentForm(bookid) == 1) {
            // ajax createStudent
            host = window.location.origin
            $.ajax({
               url: host + '/students',
               data: JSON.stringify(student),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Student Account Book" + result + " created")
                  student.bookid = result
                  addStudenttoTable(student)
                  showStudentDisplay()
                  clearStudentForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
                  // NOTE: Book has to exist to assign a student
                  alert("WARNING: INPUT ERROR ID not found!")
               }
            })
         }
      }

      function doStudentDelete(thisElem){
         var tableElement = document.getElementById('StudentTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         var student = rowElement.getAttribute("id").substr(1);
         // ajax deleteStudent
         host = window.location.origin
         $.ajax({
            url: host + "/students/"+ student,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               tableElement.deleteRow(index);
               console.log("Student Book Account " + student + " deleted")
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showHome() {
         document.getElementById('displayHome').style.display = "block"
         document.getElementById('displayBook').style.display = "none"
         document.getElementById('displayStudent').style.display = "none"
         document.getElementById('createUpdateBook').style.display = "none"
         document.getElementById('createUpdateStudent').style.display = "none"
      }

      function getBookFromForm(){
         var form = document.getElementById('createUpdateBookForm')
         var book = {}
         book.bookID = parseInt(form.querySelector('input[name="bookID"]').value)
         book.author = form.querySelector('input[name="author"]').value
         book.title = form.querySelector('input[name="title"]').value
         // console.log(book)
         return book
      }

      function validateBookForm(d){
         // Code adapted from
         // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isNaN
         if (d.author.length == 0 || d.title.length == 0) {
            alert("WARNING: Please Include an Author and Title")
            return 0
         }
         return 1
      }

      function getStudentFromForm(){
         var form = document.getElementById('createUpdateStudentForm')
         var student = {}
         student.bookid = parseInt(form.querySelector('input[name="bookid"]').value)
         student.firstname = form.querySelector('input[name="firstname"]').value
         student.lastname = form.querySelector('input[name="lastname"]').value
         student.studentID = parseInt(form.querySelector('input[name="studentID"]').value)
         // console.log(student)
         return student
      }

      function validateStudentForm(e){
         // Check if any student form fields are empty
         if (e.firstname.length == 0 || e.lastname.length == 0 || Number.isNaN(e.studentID) == true){
            alert("WARNING: Please include your Full Name and Student Number")
            return 0
         }
         return 1
      }

      function populateBookTable(){
         // ajax getAllBooks
         host = window.location.origin
         $.ajax({
            url: host + '/book',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (book of results) {
                  addBooktoTable(book)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function populateStudentTable(){
         // ajax getAllStudent
         host = window.location.origin
         $.ajax({
            url: host + '/students',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (student of results) {
                  addStudenttoTable(student)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function addBooktoTable(book){
         // console.log("add to dept table working")
         var tableElem = document.getElementById('BookTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "d"+book.bookID)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = book.bookID
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = book.author
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = book.title
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = '<button onclick="showBookUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="doBookDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      function addStudenttoTable(student){
         // console.log("add to stu table working")
         var tableElem = document.getElementById('StudentTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', +student.bookid)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = student.bookid
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = student.firstname
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = student.lastname
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = student.studentID
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="showStudentUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell6 = rowElem.insertCell(5);
         cell6.innerHTML = '<button onclick="doStudentDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      populateBookTable()
      populateStudentTable()

   </script>
</body>

</html>
